---
title: "R Notebook"
output: html_notebook
---


```{r, message=FALSE}
library(tidyverse)
library(stringr)
library(magrittr)
library(e1071)
```

Read the data

```{r, message=FALSE}

#dataset <- "4bags"

dataset <- "10bags"

if (dataset == "4bags") {
  dl_age <- read_csv("../../results/manual/4bags/SVR_predict_dl.csv", 
                     col_names = c("dl_age"), col_types = cols(dl_age = col_double()))
  
  manual_age <- read_csv("../../results/manual/4bags/SVR_predict_human.csv", 
                       col_names = c("manual_age"), col_types = cols(manual_age = col_double()))
  
}

true_age <- read_csv(sprintf("../../results/manual/%s/groundtruth.csv", dataset), 
                     col_names = c("true_age"), col_types = cols(true_age = col_double()))

dl_frac <- read_csv(sprintf("../../results/manual/%s/fraction_dl.csv", dataset), col_names = FALSE) 

manual_frac <- read_csv(sprintf("../../results/manual/%s/fraction_human.csv", dataset), col_names = FALSE) 

bag <- read_csv(sprintf("../../results/manual/%s/samples.csv", dataset), col_names = c("bag")) 

```


```{r}
data_df <- 
  bind_cols(bag %>% mutate(bag_id = str_sub(bag, 1,1), replicate_id = str_sub(bag, 2,2)) %>% select(-bag), 
            true_age)

data_df %<>% 
  mutate(training = bag_id %in% c("A", "B", "D", "E", "F", "H"),
         testing = bag_id %in% c("C"),
         holdout = bag_id %in% c("G", "I", "J"))
data_df_summary <- data_frame(bag_id = LETTERS[1:10])

data_df_summary$accuracy <- c(90.7, 91.0, 91.4, 90.9, 91.0, 89.6, 90.0, 90.3, 88.7, 89.4)

p <- 
data_df %>% 
  distinct(bag_id, true_age) %>% 
  mutate(bag_id = factor(bag_id, levels = rev(LETTERS[1:10]))) %>%
  ggplot(aes(true_age, bag_id)) + 
  geom_spoke(aes(angle = pi/2), radius=.8) +
  theme_bw() +
  theme(axis.text.x = element_blank()) +
  theme(panel.grid = element_blank()) +
  theme(axis.title = element_blank()) +
  theme(panel.border	= element_blank())

p

ggsave("timepoints.pdf", height = 8, width = 2)


```


```{r, warning=FALSE}
p <- 
data_df %>% 
  distinct(bag_id, training, testing, holdout) %>% 
  gather(type, value, -bag_id) %>% 
  mutate(bag_id = factor(bag_id, levels = rev(LETTERS[1:10]))) %>%
  mutate(type = factor(type, levels = c("training", "testing", "holdout"))) %>%
  ggplot(aes(type, bag_id, fill = value)) + 
  geom_tile(aes(width = .7, height = .7)) + 
  coord_equal() + 
  scale_fill_manual(values = c("#FFFFFF", "#000000"), guide = FALSE) +
  theme_bw() +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) +
  theme(panel.grid = element_blank()) +
  theme(axis.title = element_blank()) +
  theme(panel.border	= element_blank())

p

ggsave("train_test_holdout.pdf", height = 8, width = 3)

```

```{r}
p <-
data_df_summary %>%
  mutate(bag_id = factor(bag_id, levels = rev(LETTERS[1:10]))) %>%
  ggplot(aes(bag_id, accuracy)) + 
  scale_y_continuous(limits = c(0, 100)) +
  geom_col(alpha = 0.3) + 
  geom_text(aes(label = sprintf("%.1f%%", accuracy)), nudge_y = -25, size = 5) + 
  coord_flip() +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.title = element_blank()) +
  theme(panel.border	= element_blank())

p

ggsave("accuracy.pdf", height = 9, width = 2)

```


Define train and test split

```{r}

test_set <- str_detect(bag$bag, "2$")

train_set <- !test_set

```

Define function to compute morphology index

```{r}
# compute morphology index as defined by clinicians
compute_mi <- function(x) 
  rowSums(sweep(as.matrix(x), MARGIN = 2, STATS = c(1.0, 0.8, 0.6, 0.4, 0.2, 0.8), FUN = "*"))

# example
compute_mi(tribble(~X1, ~X2, ~X3, ~X4, ~X5, ~X6,
                   1, 1, 1, 1, 1, 1,
                   1, 1, 0, 0, 0, 0,
                   1, 0, 0, 0, 0, 0))

```

Compute MI based on DL-predicted morphologies and manually-gated morphologies
```{r}

# MI based on DL-predicted morphologies
dl_mi <- data_frame(mi = compute_mi(dl_frac))

# MI based on manually-gated morphologies
manual_mi <- data_frame(mi = compute_mi(manual_frac))

qplot(dl_mi$mi, manual_mi$mi, geom = "point") + geom_abline(slope = 1, color = "red", linetype = 2) + coord_equal()
```

Predict age based on MI. Train on manual MI, test and evaluate on DL MI

```{r}
manual_mi_df <- bind_cols(true_age, manual_mi)

dl_mi_df <- bind_cols(true_age, dl_mi)

mi_model <- lm(data = manual_mi_df[train_set, ], formula = true_age ~ mi)

summary(mi_model)

plot(mi_model)

dl_mi_predicted_age <- predict(mi_model, dl_mi_df[test_set, ])

qplot(true_age$true_age[test_set], dl_mi_predicted_age) + geom_abline(slope = 1)

```

Predict age based on morphology fractions. Train on manual fractions, test and evaluate on DL fractions. 

```{r}
manual_frac_df <- bind_cols(true_age, manual_frac)

dl_frac_df <-  bind_cols(true_age, dl_frac)

```

Because there are only 6 - 1 = 5 indepedent variations, given that the 6 variables have been
normalized to sum to one, we remove the intercept when fitting an lm. 

```{r}
frac_model_lm <- lm(data = manual_frac_df[train_set, ], formula = true_age ~ X1 + X2 + X3 + X4 + X5 + X6 - 1)

summary(frac_model_lm)

plot(frac_model_lm)

dl_frac_predicted_age_lm <- predict(frac_model_lm, dl_frac_df[test_set, ])

qplot(true_age$true_age[test_set], dl_frac_predicted_age_lm) + geom_abline(slope = 1)
```

Predict age based on morphology fractions, but this time using SVR.

```{r}

frac_model_svr <- svm(true_age ~ X1 + X2 + X3 + X4 + X5 + X6 - 1, data = manual_frac_df[train_set, ])

summary(frac_model_svr)

plot(frac_model_svr)

dl_frac_predicted_age_svr <- predict(frac_model_svr, dl_frac_df[test_set, ])

qplot(true_age$true_age[test_set], dl_frac_predicted_age_svr) + geom_abline(slope = 1)
```


```{r}
age <- bind_cols(true_age[test_set, ], 
                 data_frame(dl_mi_predicted_age), 
                 data_frame(dl_frac_predicted_age_lm),
                 data_frame(dl_frac_predicted_age_svr))

if (dataset == "4bags") {
  age %<>% bind_cols(dl_age[test_set, ], manual_age[test_set, ])

}

age <- age %>% gather(type, age, -true_age)
```


```{r}

cor_summaries <- age %>% split(age$type) %>% map(function(df) cor(df$true_age, df$age))

cor_summaries

p <- 
ggplot(age, aes(true_age, age)) + 
  geom_point() + 
  geom_smooth(method = "loess") + 
  geom_abline(slope = 1, color = "red", linetype = 2) + 
  coord_equal() + facet_wrap(~type, nrow = 1) 

p

ggsave("regression_plot.pdf", p, dpi = 300, width = 8)
```

